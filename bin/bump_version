#!/usr/bin/env ruby

require 'bundler/setup'
require 'rolemodel_rails/version'
require 'rake/file_list'
require 'thor'

class VersionBumper < Thor::Group
  include Thor::Actions

  class_exclusive do
    class_option :patch, type: :boolean, lazy_default: false, desc: 'Bump patch version instead of minor version'
    class_option :major, type: :boolean, lazy_default: false, desc: 'Bump major version instead of minor version'
    class_option :version, type: :string, desc: 'Bump to a specific version (overrides patch and major options)'
  end

  source_root File.expand_path('../', __FILE__)

  def bump_version
    gsub_file 'lib/rolemodel_rails/version.rb', /^  VERSION = .*/, "  VERSION = '#{new_version_string}'"
  end

  def update_lockfile
    run_clean_bundle_install
  end

  def build_gem
    run 'gem build rolemodel_rails.gemspec'
  end

  def update_current_example_app
    Rake::FileList.new('example_rails*').each do |example_path|
      inside(example_path) do
        run_clean_bundle_install
      end
    end
  end

  def echo_new_version
    say "New Gem Version is #{set_color(new_version_string, :yellow)}", :green
  end

  private

  def new_version_string
    @new_version_string ||= begin
      nv = current_version
      nv = nv.bump unless options.version?
      nv = nv.bump if options.major?
      nv.segments.fill(0, nv.segments.size, 3 - nv.segments.size).join('.')
    end
  end

  def current_version
    Gem::Version.new(
      if options.patch?
        RolemodelRails::VERSION + '.0'
      else
        options[:version] || RolemodelRails::VERSION
      end
    )
  end

  def run_clean_bundle_install
    Bundler.with_original_env do
      run "#{Gem.bin_path("bundler", "bundle")} install --quiet"
    end
  end

  class << self
    def banner
      <<~BANNER
        bin/bump_version [--patch|--major|--version VERSION]
      BANNER
    end

    def desc = 'Advance the gem version, build the gem, and update example apps'
  end
end

VersionBumper.start(ARGV)
