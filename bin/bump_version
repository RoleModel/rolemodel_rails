#!/usr/bin/env ruby

require 'bundler/setup'
require 'rolemodel_rails/version'
require 'rake/file_list'
require 'thor'

class VersionBumper < Thor::Group
  include Thor::Actions

  class_option :patch, type: :boolean, default: false, desc: 'Bump patch version instead of minor version'
  class_option :major, type: :boolean, default: false, desc: 'Bump major version instead of minor version'

  source_root File.expand_path('../', __FILE__)

  def bump_version
    gsub_file 'lib/rolemodel_rails/version.rb', /^  VERSION = .*/, "  VERSION = '#{new_version_string}'"
  end

  def update_lockfile
    run 'bundle exec bundle install'
  end

  def build_gem
    run 'gem build rolemodel_rails.gemspec'
  end

  def update_current_example_app
    Rake::FileList.new('example_rails*').each do |example_path|
      inside(example_path) do
        run 'bundle exec bundle install'
      end
    end
  end

  def echo_new_version
    say "New Gem Version is #{set_color(new_version_string, :yellow)}", :green
  end

  private

  def new_version_string
    @new_version_string ||= begin
      nv = current_version.bump
      nv = nv.bump if options[:major]
      nv.segments.fill(0, nv.segments.size, 3 - nv.segments.size).join('.')
    end
  end

  def current_version
    Gem::Version.new(
      if options[:patch]
        RolemodelRails::VERSION + '.0'
      else
        RolemodelRails::VERSION
      end
    )
  end
end

VersionBumper.start(ARGV)
